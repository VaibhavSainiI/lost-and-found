<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lost & Found Portal</title>
<style>
  body { font-family: sans-serif; background: #f9f9f9; margin: 0; }
  header { background: #225; color: #fff; padding: 1em; display: flex; align-items: center; justify-content: space-between; }
  section { margin: 1em auto; padding: 1em; max-width: 600px; background: #fff; border-radius: 8px; }
  form label { display: block; margin-top: 1em; }
  form input, form select { width: 100%; padding: .3em; margin-top: .3em; }
  button { background: #27a; color: #fff; padding: .6em 1.2em; border: none; border-radius: 4px; cursor: pointer; }
  ul { list-style: none; padding: 0; }
  li { background: #eef; margin: .5em 0; padding: .5em; border-radius: 4px; }
  #loading { display: none; color: #555; }
  #edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center; }
  #edit-modal > div { background: #fff; padding: 2em; border-radius: 8px; max-width: 400px; width: 90vw; position: relative; }
</style>
</head>
<body>
<header>
  <h1>Lost & Found Portal</h1>
  <button onclick="showForm(true)">Report Item</button>
</header>

<section id="item-form" style="display:none;">
  <h2>Report Lost/Found Item</h2>
  <form id="reportForm">
    <label>Type:</label>
    <select name="type" required>
      <option value="lost">Lost</option>
      <option value="found">Found</option>
    </select>
    <label>Description:</label>
    <input name="desc" required />
    <label>Location:</label>
    <input name="location" required />
    <label>Date:</label>
    <input name="date" type="date" required />
    <label>Time:</label>
    <input name="time" type="time" required />
    <label>Contact Email:</label>
    <input name="email" type="email" required />
    <label>Image:</label>
    <input name="image" type="file" accept="image/*" />
    <button type="submit">Submit</button>
    <button type="button" onclick="showForm(false)">Cancel</button>
  </form>
</section>

<section id="edit-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:2em;border-radius:8px;max-width:400px;width:90vw;position:relative;">
    <button onclick="closeEditModal()" style="position:absolute;top:8px;right:8px;">&times;</button>
    <h2>Edit Item</h2>
    <form id="editForm">
      <input name="_id" type="hidden" />
      <label>Type:</label>
      <select name="type" required>
        <option value="lost">Lost</option>
        <option value="found">Found</option>
      </select>
      <label>Description:</label>
      <input name="desc" required />
      <label>Location:</label>
      <input name="location" required />
      <label>Date:</label>
      <input name="date" type="date" required />
      <label>Time:</label>
      <input name="time" type="time" required />
      <label>Contact Email:</label>
      <input name="email" type="email" required />
      <label>Image (optional):</label>
      <input name="image" type="file" accept="image/*" />
      <button type="submit">Save Changes</button>
    </form>
  </div>
</section>

<section id="listings">
  <h2>All Items</h2>
  <input id="search" placeholder="Search..." oninput="fetchItems()" style="width: 100%; padding: 6px; margin-bottom: 1em;"/>
  <div id="loading">Loading items...</div>
  <ul id="items"></ul>
</section>

<script>
  const apiURL = 'http://localhost:3000/api/items';

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" })[m]);
  }

  function showForm(show) {
    document.getElementById('item-form').style.display = show ? 'block' : 'none';
  }

  let lastItems = [];

  async function fetchItems() {
    const query = document.getElementById('search').value.trim();
    const loading = document.getElementById('loading');
    loading.style.display = 'block';

    try {
      const res = await fetch(apiURL + (query ? `?q=${encodeURIComponent(query)}` : ''));
      console.log('Response status:', res.status);
      const text = await res.text();
      console.log('Raw response text:', text);
      if (!res.ok) {
        throw new Error('Server returned ' + res.status + ': ' + text);
      }
      let items;
      try {
        items = JSON.parse(text);
      } catch (parseErr) {
        console.error('Error parsing JSON:', parseErr);
        alert('Invalid JSON from server: ' + text);
        loading.style.display = 'none';
        return;
      }
      lastItems = items;
      loading.style.display = 'none';

      const ul = document.getElementById('items');
      ul.innerHTML = '';

      if (!Array.isArray(items) || items.length === 0) {
        ul.innerHTML = '<li>No items found.</li>';
        return;
      }

      items.forEach((item, i) => {
        ul.innerHTML += `<li>
          <b>${escapeHtml(item.type.toUpperCase())}:</b> ${escapeHtml(item.desc)} <br />
          <i>Location: ${escapeHtml(item.location)}, Date: ${escapeHtml(item.date)}, Time: ${escapeHtml(item.time || '')}</i><br />
          ${item.imageUrl ? `<img src="${item.imageUrl}" alt="Item Image" style="max-width:300px;max-height:300px;display:block;margin:12px auto;border-radius:8px;box-shadow:0 2px 8px #aaa;object-fit:cover;" />` : ''}
          <button onclick="contact('${escapeHtml(item.email)}')">Contact</button>
          <button onclick="deleteItem('${item._id}')" style="background:#c00;margin-left:8px;">Delete</button>
          <button onclick="openEditModal(${i})" style="background:#fa0;margin-left:8px;">Edit</button>
        </li>`;
      });
    } catch (err) {
      loading.style.display = 'none';
      alert('Failed to fetch items from server. ' + err.message);
    }
  }

  function contact(email) {
    alert("Contact Email: " + email);
  }

  document.getElementById('reportForm').onsubmit = async function(e) {
    e.preventDefault();
    const f = e.target;

    const formData = new FormData();
    formData.append('type', f.type.value);
    formData.append('desc', f.desc.value);
    formData.append('location', f.location.value);
    formData.append('date', f.date.value);
    formData.append('time', f.time.value);
    formData.append('email', f.email.value);
    if (f.image.files[0]) {
      formData.append('image', f.image.files[0]);
    }

    try {
      const res = await fetch(apiURL, {
        method: 'POST',
        body: formData
      });

      if (!res.ok) throw new Error('Failed to save item');

      alert('Item reported successfully!');
      f.reset();
      showForm(false);
      fetchItems();
    } catch (err) {
      alert('Error submitting item: ' + err.message);
    }
  };

  async function deleteItem(id) {
    if (!confirm('Are you sure you want to delete this item?')) return;
    try {
      const res = await fetch(apiURL + '/' + id, { method: 'DELETE' });
      if (!res.ok) throw new Error('Failed to delete item');
      alert('Item deleted successfully!');
      fetchItems();
    } catch (err) {
      alert('Error deleting item: ' + err.message);
    }
  }

  function openEditModal(idx) {
    const item = lastItems[idx];
    const modal = document.getElementById('edit-modal');
    const form = document.getElementById('editForm');
    form._id.value = item._id;
    form.type.value = item.type;
    form.desc.value = item.desc;
    form.location.value = item.location;
    form.date.value = item.date;
    form.time.value = item.time || '';
    form.email.value = item.email;
    modal.style.display = 'flex';
  }
  function closeEditModal() {
    document.getElementById('edit-modal').style.display = 'none';
  }
  document.getElementById('editForm').onsubmit = async function(e) {
    e.preventDefault();
    const f = e.target;
    const id = f._id.value;
    const formData = new FormData();
    formData.append('type', f.type.value);
    formData.append('desc', f.desc.value);
    formData.append('location', f.location.value);
    formData.append('date', f.date.value);
    formData.append('time', f.time.value);
    formData.append('email', f.email.value);
    if (f.image.files[0]) {
      formData.append('image', f.image.files[0]);
    }
    const url = apiURL + '/' + id;
    console.log('PUT URL:', url);
    try {
      const res = await fetch(url, {
        method: 'PUT',
        body: formData
      });
      if (!res.ok) throw new Error('Failed to update item');
      alert('Item updated successfully!');
      closeEditModal();
      fetchItems();
    } catch (err) {
      alert('Error updating item: ' + err.message);
    }
  };

  // Initial load
  fetchItems();
</script>
</body>
</html>
